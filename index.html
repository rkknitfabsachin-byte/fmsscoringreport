<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RK KNIT FAB â€“ Performance Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{
  margin:0;
  padding:20px;
  font-family:Poppins, sans-serif;
  background:linear-gradient(135deg,#dfe9f3,#ffffff);
}

h2{
  text-align:center;
  margin-bottom:20px;
}

.filters{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:20px;
}

input, select, button{
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:15px;
}

button{
  background:#007bff;
  color:white;
  cursor:pointer;
}

.section{
  margin-top:20px;
}

.card{
  padding:15px;
  border-radius:14px;
  background:rgba(255,255,255,0.45);
  backdrop-filter:blur(8px);
  margin-bottom:12px;
  border:1px solid rgba(255,255,255,0.5);
}

.green{border-left:8px solid #28a745;}
.blue{border-left:8px solid #007bff;}
.yellow{border-left:8px solid #ffc107;}
.orange{border-left:8px solid #fd7e14;}
.red{border-left:8px solid #dc3545;}
.grey{border-left:8px solid #6c757d;}
</style>
</head>

<body>

<h2>Performance Dashboard</h2>

<div class="filters">
  <div>
    <label>Start:</label><br>
    <input type="date" id="start">
  </div>

  <div>
    <label>End:</label><br>
    <input type="date" id="end">
  </div>

  <div>
    <label>Month:</label><br>
    <input type="month" id="month">
  </div>

  <button onclick="filterRange()">Day Range</button>
  <button onclick="filterWeekly()">Weekly</button>
  <button onclick="filterMonthly()">Monthly</button>
  <button onclick="downloadPDF()">Download PDF</button>
</div>

<div id="cards"></div>

<canvas id="chart" style="margin-top:30px;"></canvas>

<script>

const API = "https://script.google.com/macros/s/AKfycbyInh3gz5YOQv45LvW-IkghTYQJNvhAjus06BNmDr6xGreaexxK0_QHXJ5OfbR2HvvX/exec";

let fullData = [];

async function loadData(url){
  fullData = await (await fetch(url)).json();
  render();
}

function render(){
  
  let container = "";

  fullData.forEach(d => {

    let colorClass = "grey";
    if (d.type === "Early") colorClass = "green";
    else if (d.type === "On-Time") colorClass = "blue";
    else if (d.type === "Late") colorClass = "yellow";
    else if (d.type === "Very Late") colorClass = "orange";
    else if (d.type === "Overdue") colorClass = "red";

    container += `
      <div class="card ${colorClass}">
        <h3>${d.step}</h3>
        <p>Score: <b>${d.score}</b></p>
        <p>Status: ${d.type}</p>
      </div>
    `;
  });

  document.getElementById("cards").innerHTML = container;
  drawChart();
}

function drawChart(){

  const ctx = document.getElementById("chart").getContext("2d");
  const labels = fullData.map(d => d.step);
  const scores = fullData.map(d => d.score);

  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Score",
        data: scores,
        borderWidth: 1
      }]
    }
  });
}

function filterRange(){
  const s = start.value;
  const e = end.value;
  loadData(`${API}?mode=range&start=${s}&end=${e}`);
}

function filterWeekly(){
  loadData(`${API}?mode=weekly`);
}

function filterMonthly(){
  const m = month.value;
  loadData(`${API}?mode=monthly&month=${m}`);
}

function downloadPDF(){
  html2pdf().from(document.body).save("performance.pdf");
}

loadData(API);

</script>

</body>
</html>
